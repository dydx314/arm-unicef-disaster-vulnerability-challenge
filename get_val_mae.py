#python script to get a csv of inference results and calculate the mae of the results
#in particular, csv should have rows of the form: id_08ren5g2j8hu.tif_0,0 where the first value
#is the image name + class and the second value is the number of predictions for that class

import os
import numpy as np
import sys

def get_val_mae(csv_path):
    data = np.loadtxt(csv_path, delimiter=',', dtype=str)
    n = 0
    error = 0
    for i in range(data.shape[0]):
        image_id = data[i][0][:-6]
        class_name = int(data[i][0][-1]) #no need to do +1
        pred = int(data[i][1])
        label_path = "./data/val/labels/" + image_id + ".txt"
        if (os.path.isfile(label_path) == False):
            n+=1
            print(label_path)
            continue

        label_data = np.loadtxt(label_path)
        if len(label_data.shape) == 1:
            label_data = np.array([label_data])
        
        counts = np.sum(label_data[:,0] == class_name)
        
        n += 1
        if np.max([counts, pred]) == 0:
            error = (n)/(n+1) * error
        else:
            error = (n)/(n+1) * error +  np.abs((counts - pred))/((n+1) * np.max([counts, pred]))
        print(error)

    return error

print(get_val_mae(sys.argv[1]))

# Usage: python get_val_mae.py <path_to_csv>
# Example: python get_val_mae.py val_final.csv