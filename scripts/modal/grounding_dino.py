from modal_store import zindi_image, zindi_volumes, REMOTE_DIR
from modal import App

import utils
import pandas as pd
import cv2
from collections import Counter
from classify_roof import classify_roof

app = App()

with zindi_image.imports():
    import cv2
    import matplotlib.pyplot as plt
    import requests
    import torch
    from PIL import Image
    from transformers import AutoModelForZeroShotObjectDetection, AutoProcessor


@app.function(image=zindi_image, volumes=zindi_volumes, timeout=7200, gpu="any")
def run_detection(img_ids, text):
    img_dir = f"{REMOTE_DIR}/data/Images"
    device = "cuda"
    model_id = "IDEA-Research/grounding-dino-tiny"

    processor = AutoProcessor.from_pretrained(model_id)
    model = AutoModelForZeroShotObjectDetection.from_pretrained(model_id).to(device)

    results = {}
    for img_id in img_ids:
        image = Image.open(f"{img_dir}/{img_id}.tif")
        inputs = processor(images=image, text=text, return_tensors="pt").to(device)
        with torch.no_grad():
            outputs = model(**inputs)

        result = processor.post_process_grounded_object_detection(
            outputs,
            inputs.input_ids,
            box_threshold=0.1,
            text_threshold=0.1,
            target_sizes=[image.size[::-1]],
        )[0]
        results[img_id] = {
            "scores": result["scores"].tolist(),
            "labels": result["labels"],
            "boxes": result["boxes"].tolist(),
        }
    return results


def detect_plot_10():
    train_df = pd.read_csv("data/train.csv")
    img_ids = train_df[:10].image_id.values
    # text = "houses with tin roof."
    text = "metal-roof houses."

    results = run_detection.remote(img_ids, text)

    for img_id in img_ids:
        img_path_local = f"../../Downloads/Images/{img_id}.tif"
        image = Image.open(img_path_local)
        result_dict = results[img_id]
        utils.plot_results(
            image,
            text,
            result_dict["scores"],
            result_dict["labels"],
            result_dict["boxes"],
            show_plot=False,
            save_path=f"results/grounding_dino/tin/{img_id}.tif",
        )

    # text = "houses with grass-thatched roof."
    text = "grass-roof houses."

    results = run_detection.remote(img_ids, text)

    for img_id in img_ids:
        img_path_local = f"../../Downloads/Images/{img_id}.tif"
        image = Image.open(img_path_local)
        result_dict = results[img_id]
        utils.plot_results(
            image,
            text,
            result_dict["scores"],
            result_dict["labels"],
            result_dict["boxes"],
            show_plot=False,
            save_path=f"results/grounding_dino/thatched/{img_id}.tif",
        )

        # bboxes = train_df[train_df.image_id == img_id]["bbox"].values
        # labels = train_df[train_df.image_id == img_id]["category_id"].values
        # utils.plot_ground_truth(
        #     img_path_local,
        #     bboxes,
        #     labels,
        #     show_plot=False,
        #     save_path=f"data/img_bbox/{img_id}.tif",
        # )


def plot(img_ids, text, results, show_plot=False):
    for img_id in img_ids:
        img_path_local = f"../../Downloads/Images/{img_id}.tif"
        image = Image.open(img_path_local)
        result_dict = results[img_id]
        utils.plot_results(
            image,
            text,
            result_dict["scores"],
            result_dict["labels"],
            result_dict["boxes"],
            show_plot=show_plot,
        )


def evaluate_test_naive():
    test_df = pd.read_csv("data/final/Test.csv")
    img_ids = test_df.image_id.values
    text = "metal-roof houses."
    results_2 = run_detection.remote(img_ids, text)

    # text = "grass-roof houses."
    # results_3 = run_detection.remote(img_ids, text)

    submission_tuples = []
    for img_id in img_ids:
        submission_tuples.extend(
            [
                (f"{img_id}_1", 0),
                (f"{img_id}_2", len(results_2[img_id]["labels"])),
                (f"{img_id}_3", 0),
            ]
        )
    submission_df = pd.DataFrame(submission_tuples, columns=["image_id", "Target"])
    submission_df.to_csv("results/grounding_dino/test_pred.csv", index=False)


def evaluate_val_naive(limit=None):
    val_df = pd.read_csv("data/val.csv")
    if limit:
        val_df = val_df[:limit]
    img_ids = val_df.image_id.values
    text = "metal-roof houses."
    results_2 = run_detection.remote(img_ids, text)

    # text = "grass-roof houses."
    # results_3 = run_detection.remote(img_ids, text)

    labels_dict = {}
    for img_id in img_ids:
        labels_dict[img_id] = [2] * len(results_2[img_id]["labels"])

    gen_val_pred(labels_dict, "naive")


def gen_val_pred(labels_dict, val_pred_id):
    val_pred_tuples = []
    for img_id, labels in labels_dict.items():
        labels_count = Counter(labels)
        val_pred_tuples.extend(
            [
                (f"{img_id}_1", labels_count[1]),
                (f"{img_id}_2", labels_count[2]),
                (f"{img_id}_3", labels_count[3]),
            ]
        )
    val_pred_df = pd.DataFrame(val_pred_tuples, columns=["image_id", "Target"])
    val_pred_df.to_csv(
        f"results/grounding_dino/val_pred_{val_pred_id}.csv", index=False
    )

    # MAE
    val_target_df = pd.read_csv("data/val_target.csv")
    print("MAE is:", utils.mae(val_pred_df, val_target_df))


def evaluate_val(limit=None):
    val_df = pd.read_csv("data/val.csv")
    if limit:
        val_df = val_df[:limit]
    img_ids = val_df.image_id.values
    text = "roof"  # aim for high recall
    results = run_detection.remote(img_ids, text)

    labels_dict = {}
    for img_id in results:
        bounding_boxes = results[img_id]["boxes"]
        labels_dict[img_id] = classify_roof(img_id, bounding_boxes)
    gen_val_pred(labels_dict, "color_based")


def detect_plot_one(img_id, text):
    results = run_detection.remote([img_id], "rectangle")
    img_path_local = f"../../Downloads/Images/{img_id}.tif"
    image = Image.open(img_path_local)
    result_dict = results[img_id]
    utils.plot_results(
        image,
        text,
        result_dict["scores"],
        result_dict["labels"],
        result_dict["boxes"],
        show_plot=True,
        save_path=f"results/grounding_dino/all/{img_id}.tif",
    )
    return result_dict


def test_extract_patch():
    img_id = "id_av0kj02v1wvd"
    text = "roof"

    result_dict = detect_plot_one(img_id, text)
    print(result_dict)

    img_path_local = f"../../Downloads/Images/{img_id}.tif"
    patches = utils.extract_patches(img_path_local, result_dict["boxes"])

    for i, patch in enumerate(patches):
        # Save the patch
        cv2.imwrite(f"test/patch_{i}.jpg", patch)


@app.local_entrypoint()
def main():
    # evaluate_10()
    # evaluate_val()
    # evaluate_test()
    evaluate_val()
