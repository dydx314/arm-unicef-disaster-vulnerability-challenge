from modal import App
from PIL import Image

from modal_store import REMOTE_DIR, zindi_image, zindi_volumes
from models.grounding_dino import annotate_image, load_model_hf

app = App()


@app.function(image=zindi_image, volumes=zindi_volumes, gpu="any")
def test_annotate():
    import os
    # print(os.environ.get('CUDA_HOME'))
    # return os.environ.get('CUDA_HOME')
    os.environ["CUDA_HOME"] = "/usr/local/cuda"

    img_path = f"{REMOTE_DIR}/art_dog_birthdaycake.png"
    model = load_model_hf()
    annotated_img = annotate_image(model, img_path, "dog. cake.")
    return annotated_img


@app.local_entrypoint()
def main():
    #annotated_img = test_annotate.remote()
    #Image.fromarray(annotated_img)
    print(test_annotate.remote())
