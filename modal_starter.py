import modal
from modal import Image, Volume
import yaml

EPOCHS = 60
BATCH_SIZE = 32
OPTIMIZER = "auto"
SEED = 42
NAME = f"Arm_Yolo_{EPOCHS}"
DEVICE = [0]
VERBOSE = False
RESUME = False
PATIENCE = 20
img_width = 500
img_height = 500

def read_yaml_file(file_path):
    with open(file_path, 'r') as file:
        try:
            data = yaml.safe_load(file)
            return data
        except yaml.YAMLError as e:
            print("Error reading YAML:", e)
            return None
        
def print_files_in_path(path):
    try:
        # List all files and directories in the specified path
        with os.scandir(path) as entries:
            for entry in entries:
                # Check if the entry is a file
                if entry.is_file():
                    print(entry.name)
    except FileNotFoundError:
        print(f"The path {path} does not exist")
    except PermissionError:
        print(f"Permission denied for the path {path}")
    except Exception as e:
        print(f"An error occurred: {e}")

#we build a container and copy our local training data to it
yolo_image = (
    Image.debian_slim(python_version="3.9")
    .pip_install("matplotlib", "numpy", "pandas", "ultralytics", "Pillow")
    .apt_install("libgl1", "libglib2.0-0")
)

volume = modal.Volume.from_name("model-store")
model_store_path = "/vol/models"

with yolo_image.imports():
    import numpy as np
    import pandas as pd 
    import matplotlib.pyplot as plt
    import matplotlib.patches as patches
    from ultralytics import YOLO
    import os


app = modal.App(
    "yolo-example"
)

@app.function(image=yolo_image,volumes={model_store_path: volume},gpu="any")
def train():
    #here, we assume the python notebook has already been run to setup the repos
    model = YOLO('yolov8n.pt')

    #check image set up correctly
    print_files_in_path("./data")

    ### train
    model.train(
        data = "./data/data.yaml",
        task = 'detect',
        imgsz = (img_height, img_width),
        epochs = EPOCHS,
        batch = BATCH_SIZE,
        optimizer = OPTIMIZER,
        patience = PATIENCE,
        name = NAME,
        seed = SEED,
        val = True,
        resume = RESUME,
        device = DEVICE,
        verbose = VERBOSE
    )
    model.export(
        format = 'onnx', # openvino, onnx, engine, tflite
        imgsz = (img_height, img_width),
        half = False,
        int8 = False,
        simplify = False,
        nms = False,
    )

    ### save model to volume
    model.save(f"{model_store_path}/{NAME}")
    volume.commit()


@app.local_entrypoint()
def main():
    train.remote()
