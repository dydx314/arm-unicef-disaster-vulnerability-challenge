import os
from typing import Tuple

import matplotlib.pyplot as plt
import pandas as pd
from sklearn.model_selection import train_test_split
from PIL import Image
import numpy as np
import re
import matplotlib.patches as patches

# colors for visualization
COLORS = [
    [0.000, 0.447, 0.741],
    [0.850, 0.325, 0.098],
    [0.929, 0.694, 0.125],
    [0.494, 0.184, 0.556],
    [0.466, 0.674, 0.188],
    [0.301, 0.745, 0.933],
]


def split_train_val(df: pd.DataFrame) -> Tuple[pd.DataFrame, pd.DataFrame]:
    unique_images = df["image_id"].unique()
    train_images, val_images = train_test_split(
        unique_images, test_size=0.2, random_state=42
    )
    train_df = df[df["image_id"].isin(train_images)]
    val_df = df[df["image_id"].isin(val_images)]
    return train_df, val_df

def decode_points(ddbox: str) -> list:
    points = [np.float32(point) for point in re.findall(r'\d+\.\d+', ddbox)]
    return points

def plot_ground_truth(img_path, bboxes, save_name=None):
    img = Image.open(img_path)

    fig, ax = plt.subplots(1)

    ax.imshow(img)

    for bbox in bboxes:
        x, y, w, h = decode_points(bbox)
        rect = patches.Rectangle((x, y), w, h, linewidth=1, edgecolor='r', facecolor='none')
        ax.add_patch(rect)

    plt.axis('off')  # Turn off axis
    if save_name:
        plt.savefig(save_name, bbox_inches="tight")
    plt.show()


def plot_results(pil_img, text, scores, labels, boxes, save_name=None):
    plt.figure(figsize=(16, 10))
    plt.imshow(pil_img)
    ax = plt.gca()
    colors = COLORS * 100
    for score, label, (xmin, ymin, xmax, ymax), c in zip(scores, labels, boxes, colors):
        ax.add_patch(
            plt.Rectangle(
                (xmin, ymin), xmax - xmin, ymax - ymin, fill=False, color=c, linewidth=3
            )
        )
        label = f"{text}: {score:0.2f}"
        ax.text(
            xmin, ymin, label, fontsize=15, bbox=dict(facecolor="yellow", alpha=0.5)
        )
    plt.axis("off")
    if save_name:
        plt.savefig(save_name, bbox_inches="tight")
    #plt.show()


def print_files_in_path(path):
    try:
        # List all files and directories in the specified path
        with os.scandir(path) as entries:
            for entry in entries:
                # Check if the entry is a file
                if entry.is_file():
                    print(entry.name)
    except FileNotFoundError:
        print(f"The path {path} does not exist")
    except PermissionError:
        print(f"Permission denied for the path {path}")
    except Exception as e:
        print(f"An error occurred: {e}")


def gen_data_by_class(df):
    df_by_class = df.groupby(["image_id", "category_id"]).count()
    return df_by_class
