import os
from typing import Tuple

import matplotlib.pyplot as plt
import pandas as pd
from sklearn.model_selection import train_test_split
from PIL import Image
import numpy as np
import re
import matplotlib.patches as patches

# colors for visualization
COLORS = [
    [0.000, 0.447, 0.741],
    [0.850, 0.325, 0.098],
    [0.929, 0.694, 0.125],
    [0.494, 0.184, 0.556],
    [0.466, 0.674, 0.188],
    [0.301, 0.745, 0.933],
]


def split_train_val(df: pd.DataFrame) -> Tuple[pd.DataFrame, pd.DataFrame]:
    unique_images = df["image_id"].unique()
    train_images, val_images = train_test_split(
        unique_images, test_size=0.2, random_state=42
    )
    train_df = df[df["image_id"].isin(train_images)]
    val_df = df[df["image_id"].isin(val_images)]
    return train_df, val_df

def gen_target_df(df):
    img_ids = df.image_id.values
    target_tuples = [
        (f"{img_id}_{cid}", len(df[(df.image_id == img_id) & (df.category_id == cid)]))
        for cid in [1, 2, 3] for img_id in img_ids
    ]
    target_df = pd.DataFrame(target_tuples, columns=['image_id', 'Target'])

    return target_df

def mean_absolute_error(pred_df, target_df):
    df = pd.merge(target_df, pred_df, on='image_id', how='left').fillna(0)
    df["abs_error"] = (df["Target_x"] - df["Target_y"]).abs()
    return df["abs_error"].mean()


def decode_points(ddbox: str) -> list:
    points = [np.float32(point) for point in re.findall(r'\d+\.\d+', ddbox)]
    return points

def plot_ground_truth(img_path, bboxes, labels, show_plot=True, save_path=None):
    img = Image.open(img_path)

    fig, ax = plt.subplots(1)

    ax.imshow(img)

    for bbox, label in zip(bboxes, labels):
        x, y, w, h = decode_points(bbox)
        rect = patches.Rectangle((x, y), w, h, linewidth=1, edgecolor='r', facecolor='none')
        ax.add_patch(rect)
        ax.text(x, y, int(label), fontsize=10, bbox=dict(facecolor='yellow', alpha=0.3))
    plt.axis('off')  # Turn off axis
    if save_path:
        plt.savefig(save_path, bbox_inches="tight")
    if show_plot:
        plt.show()

def plot_results(pil_img, text, scores, labels, boxes, show_plot=True, save_path=None):
    plt.figure(figsize=(16, 10))
    plt.imshow(pil_img)
    ax = plt.gca()
    colors = COLORS * 100
    for score, label, (xmin, ymin, xmax, ymax), c in zip(scores, labels, boxes, colors):
        ax.add_patch(
            plt.Rectangle(
                (xmin, ymin), xmax - xmin, ymax - ymin, fill=False, color=c, linewidth=3
            )
        )
        label = f"{text}: {score:0.2f}"
        ax.text(
            xmin, ymin, label, fontsize=15, bbox=dict(facecolor="yellow", alpha=0.5)
        )
    plt.axis("off")
    if save_path:
        plt.savefig(save_path, bbox_inches="tight")
    if show_plot:
        plt.show()


def print_files_in_path(path):
    try:
        # List all files and directories in the specified path
        with os.scandir(path) as entries:
            for entry in entries:
                # Check if the entry is a file
                if entry.is_file():
                    print(entry.name)
    except FileNotFoundError:
        print(f"The path {path} does not exist")
    except PermissionError:
        print(f"Permission denied for the path {path}")
    except Exception as e:
        print(f"An error occurred: {e}")

